{% extends "base.html" %}

{% block javascript %}
<script></script>
{% endblock %}

{% block stylesheet %}
<style>
	.ui.action.input input[type="file"] {
		display: none;
	}
</style>
{% endblock %}

{% block body %}
<div class="ui stackable one column vertically divided grid container">
	<div class="column">
		<div class="ui segment">
			<h3>Bounding Box</h3>
			<div class="ui action input">
				<input type="text" placeholder="Select Image" readonly>
				<input id="image" type="file" accept="image/*">
				<div class="ui icon button">
					<i class="icon image"></i>
				</div>
			</div>

			<button class="ui primary button" onclick="get_bbox()" id="btn1">Detect</button>
			<p>supported classes (demo): chicken wings, french fries, hamburger, hot dog, pizza</p>
			<h5>Image:</h5>
			<canvas id="canvas"></canvas>
			<h5>JSON:</h5>
			<pre id="response_bbox"></pre>
		</div>
	</div>
	<div class="column">
		<div class="ui segment" id="search_recipes_form">
			<h3>Recipes</h3>
			<div class="ui input focus">
				<input type="text" name="foodkeyword" placeholder="food keyword">
			</div>
			<button class="ui primary button" onclick="search_recipes()" id="btn2">Search</button>
			<button class="ui button" onclick="$('#response_recipes').html('')">Clear</button>
			<h5>JSON:</h5>
			<pre id="response_recipes"></pre>
		</div>
	</div>

	<div class="column">
		<div class="ui segment" id="search_restaurants_list_form">
			<h3>Restaurant List</h3>
			<div class="ui input focus"><input name="foodkeyword" type="text" placeholder="food keyword"></div>
			<div class="ui input focus"><input name="latlong" type="text" placeholder="Lat,Long(22.280276,114.176953)"></div>
			<div class="ui input focus"><input name="radius" type="text" placeholder="radius(1000)"></div>
			<button class="ui primary button" onclick="search_restaurants_list()" id="btn3">Search</button>
			<button class="ui button" onclick="$('#response_restaurants_list').html('')">Clear</button>
			<h5>JSON:</h5>
			<pre id="response_restaurants_list"></pre>
		</div>
	</div>

	<div class="column">
		<div class="ui segment" id="search_restaurants_details_form">
			<h3>Restaurant Details</h3>
			<div class="ui input focus"><input name="place_id" type="text" placeholder="place id"></div>
			<button class="ui primary button" onclick="search_restaurants_details()" id="btn4">Search</button>
			<button class="ui button" onclick="$('#response_restaurants_details').html('')">Clear</button>
			<p>example place_id: ChIJv3gz8FAABDQR9wNAjYOeZb8</p>
			<h5>JSON:</h5>
			<pre id="response_restaurants_details"></pre>
		</div>
	</div>
</div>
<script>

	$("input:text").click(function () {
		$(this).parent().find("input:file").click();
	});

	$('input:file', '.ui.action.input').on('change', function (e) {
		var name = e.target.files[0].name;
		$('input:text', $(e.target).parent()).val(name);
	});

	var canvas = document.getElementById('canvas');
	var ctx = canvas.getContext('2d');

	var image = document.getElementById('image');
	var img = new Image();
	img.onload = function () {
		canvas.width = img.width;
		canvas.height = img.height;
		ctx.drawImage(img, 0, 0, img.width, img.height);
		rect = canvas.getBoundingClientRect();
	}
	image.addEventListener("change", function (event) {
		let file = event.target.files[0];
		if (file.type.match('image.*')) {
			let reader = new FileReader();
			reader.readAsDataURL(file);
			reader.onload = function (event) {
				if (event.target.readyState == FileReader.DONE) {
					img.src = event.target.result;
					hasImg = true;
				}
			}
		} else {
			alert("not an image");
		}
	});
	function drawPrediction(predictions) {
		for (var i = 0; i < predictions.length; i++) {
			var pred = predictions[i];
			var label = pred.label;
			var similarity = parseFloat(pred.similarity).toFixed(2);
			ctx.beginPath();
			ctx.lineWidth = 2;
			ctx.strokeStyle = "#00ff00";
			ctx.fillStyle = "#ffff00"
			ctx.font = "14px Arial";
			ctx.moveTo(pred.x1, pred.y1);
			ctx.lineTo(pred.x2, pred.y1);
			ctx.lineTo(pred.x2, pred.y2);
			ctx.lineTo(pred.x1, pred.y2);
			ctx.lineTo(pred.x1, pred.y1);
			ctx.stroke();
			ctx.fillText(label + "(" + similarity + ")", pred.x1 + 4, pred.y1 + 12);
		}
	}
	function get_bbox() {
		$('#btn1').toggleClass('loading');
		var formData = new FormData();
		formData.append('file', image.files[0]);
		fetch($('#server_endpoint').val() + '/darknet/detect', {
			method: 'POST',
			body: formData
		})
		.then(response => response.json())
		.then(function (response) {
			console.log(response);
			drawPrediction(response);
			$('#response_bbox').html(JSON.stringify(response, undefined, 4));
			$('#btn1').toggleClass('loading');
		})
	}

	function search_recipes(){
		$('#btn2').toggleClass('loading');
		var url = new URL($('#server_endpoint').val()+'/recipes/search');
		url.searchParams.append('foodkeyword', $('#search_recipes_form').find('input[name="foodkeyword"]').val());
		fetch(url, { method: 'GET'})
		.then(response => response.json())
		.then(response => {
			$('#response_recipes').html(JSON.stringify(response, undefined, 4));
			$('#btn2').toggleClass('loading');
		})
	}

	function search_restaurants_list(){
		$('#btn3').toggleClass('loading');
		var url = new URL($('#server_endpoint').val()+'/place/search');
		url.searchParams.append('foodkeyword',$('#search_restaurants_list_form').find('input[name="foodkeyword"]').val());
		url.searchParams.append('latlong',$('#search_restaurants_list_form').find('input[name="latlong"]').val());
		url.searchParams.append('radius',$('#search_restaurants_list_form').find('input[name="radius"]').val());
		fetch(url, {method: 'GET' })
		.then(response => response.json())
		.then(response => {
			$('#response_restaurants_list').html(JSON.stringify(response, undefined, 4));
			$('#btn3').toggleClass('loading');
		})
	}

	function search_restaurants_details(){
		$('#btn4').toggleClass('loading');
		var url = new URL($('#server_endpoint').val()+'/place/details');
		url.searchParams.append('place_id',$('#search_restaurants_details_form').find('input[name="place_id"]').val())
		fetch(url, { method: 'GET' })
		.then(response => response.json())
		.then(response => {
			$('#response_restaurants_details').html(JSON.stringify(response, undefined, 4))
			$('#btn4').toggleClass('loading');
		})
	}
</script>
{% endblock %}